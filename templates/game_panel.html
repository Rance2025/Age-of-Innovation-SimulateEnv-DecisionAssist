    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>对局信息面板</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            :root {
                --bg-primary: #0a0a0a;
                --bg-secondary: #1a1a1a;
                --bg-tertiary: #252525;
                --bg-elevated: #2a2a2a;
                --text-primary: #f0f0f0;
                --text-secondary: #a0a0a0;
                --accent: #007bff;
                --accent-light: #4da6ff;
                --border: #333333;
                --gap: 14px;
                --border-radius: 10px;
                --panel-padding: 12px;
            }
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                overflow: hidden;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .container {
                width: 100%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                padding: var(--gap);
                box-sizing: border-box;
            }
            
            .main-container {
                display: flex;
                gap: var(--gap);
                flex: 1;
                height: 100%;
                overflow: hidden;
            }
            
            /* ===== 左侧：玩家监控区 (25%) ===== */
            .players-monitor {
                width: 28%;
                height: 100%;
                overflow: hidden;
                background-color: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: var(--border-radius);
            }
            
            .monitor-header {
                padding: 10px var(--panel-padding);
                height: 5%;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                font-size: 1.1rem;
                color: var(--text-primary);
            }
            
            .monitor-header i {
                color: var(--accent);
            }
            
            .monitor-content {
                flex: 1;
                display: flex;
                height: 94%;
                flex-direction: column;
                overflow: hidden;
                padding: 0;
                border-radius: 10px;
                border: 1px solid #262626;
                margin-left: 9px;
                margin-right: 9px;
                margin-bottom: 8px;
                background-color: #171717;
            }
            
            .player-grid {
                display: flex;
                flex-direction: column;
                gap: var(--gap);
                padding: var(--gap);
                flex: 1;
                overflow-y: auto;
                max-height: 100%;
                /* min-height: 0; 关键修复：允许内容区域收缩 */
            }

            /* 隐藏Webkit浏览器（Chrome, Safari）的滚动条 */
            .player-grid::-webkit-scrollbar {
                display: none;
            }
            
            .player-card {
                background-color: var(--bg-tertiary);
                border-radius: var(--border-radius);
                border: 1px solid var(--border);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                height: 32.3%; /* 使用max-height替代height */
                flex-shrink: 0;
                transition: height 0.3s ease; /* 过渡max-height属性 */
            }


            .player-status {
                flex: 1;
                display: flex;
                overflow: hidden;
                min-height: 0;
                transition: opacity 0.3s ease;
                opacity: 1;
            }


            .player-card:hover {
                border-color: var(--accent);
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
            }
            
            .player-card.collapsed .player-status {
                opacity: 0;
            }

            /* 确保收缩状态下的高度 */
            .player-card.collapsed {
                height: 50px; /* 收缩后的高度，等于标题栏高度 */
            }
            
            .player-header {
                padding: 8px var(--panel-padding);
                background-color: var(--bg-tertiary);
                border-bottom: 1px solid var(--border);
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: background-color 0.2s;
                flex-shrink: 0;
                height: 50px; 
                /* 明确设置标题栏高度 */
                box-sizing: border-box;
            }

            .player-header:hover {
                background-color: rgba(77, 166, 255, 0.1);
            }

            .player-header-left {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            /* 规划卡指示器 */
            .planning-card-indicator {
                display: flex;
                align-items: center;
            }

            .planning-card-circle {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background-color: #ffffff;
                border: 0;
            }

            /* 派系徽章 */
            .faction-badge {
                background-color: rgba(77, 166, 255, 0.2);
                color: var(--accent-light);
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: 600;
                margin-left: 6px;
                border: 1px solid rgba(77, 166, 255, 0.3);
            }

            /* 玩家标题 */
            .player-title {
                font-size: 1rem;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
            }
            
            .player-score {
                background-color: transparent;
                color: var(--accent);
                padding: 0;
                border: none;
                font-weight: 700;
                font-size: 1.1rem;
            }
            
            .player-status {
                flex: 1;
                display: flex;
                overflow: hidden;
                min-height: 0;
                transition: 
                    opacity 0.3s ease,
                    transform 0.3s ease, /* 添加变换过渡 */
                    margin 0.3s ease,
                    visibility 0.3s ease; /* 添加可见性过渡 */
                opacity: 1;
                transform: scaleY(1); /* 正常状态：垂直缩放为1 */
                transform-origin: top; /* 变换原点在顶部 */
                visibility: visible; /* 正常状态：可见 */
            }
            
            .player-stats {
                flex: 1;
                padding: var(--panel-padding);
                border-right: 1px solid var(--border);
                overflow: hidden;
                background-color: var(--bg-elevated);
            }
            
            /* 玩家状态面板新样式 */
            .stat-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 2px solid var(--border);
            }

            .stat-row:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }

            .stat-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                flex: 1;
                border-right: 1px solid var(--border);
                margin-top: 6px;
                margin-bottom: 6px;
            }
            
            .stat-item:last-child {
                border-right: none;
            }

            .stat-content {
                display: flex;
                align-items: center;
                gap: 6px; /* 控制图标和数字之间的间距 */
                justify-content: center;
                width: 100%;
            }

            .stat-icon {
                font-size: 1rem;
                flex-shrink: 0;
            }

            /* 图标颜色定义 */
            .fa-coins { color: gold; }
            .fa-cube { color: silver; }
            .fa-user { color: #ff6b6b; }
            .fa-university { color: #4ecdc4; }
            .fa-gavel { color: #45b7d1; }
            .fa-cog { color: #96ceb4; }
            .fa-heartbeat { color: #feca57; }
            .fa-city { color: #ff9ff3; }
            .fa-ship { color: #54a0ff; }
            .fa-digging { color: #a29bfe; }

            /* 图标堆叠样式 */
            .icon-stack {
                position: relative;
                display: inline-block;
                width: 1.5em;
                height: 1.5em;
                flex-shrink: 0;
            }

            .icon-background {
                position: absolute;
                top: 0;
                left: 0;
                font-size: 1.5em;
                color: #e4e4e4;
            }

            .icon-foreground {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 0.7em;
                color: #0a0a0a;
            }

            .stat-value {
                font-size: 1rem;
                font-weight: 700;
                color: var(--text-primary);
                white-space: nowrap;
            }

            .player-log {
                flex: 1.5;
                padding: var(--panel-padding);
                overflow-y: auto;
                font-size: 0.8rem;
                line-height: 1.4;
                color: var(--text-secondary);
                background-color: var(--bg-secondary);
            }
            .player-log::-webkit-scrollbar {
                display: none;
            }
            
            /* 修改日志项样式，支持自定义颜色 */
            .log-item {
                background-color: var(--bg-tertiary);
                border-left: 2px solid var(--accent); /* 默认颜色 */
                padding: 6px;
                margin-bottom: 4px;
                border-radius: 0 0 0 0;
                font-family: 'Consolas', monospace;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            /* 支持不同颜色的边框 */
            .log-item[data-color="blue"] { border-left-color: #007bff; }
            .log-item[data-color="orange"] { border-left-color: #f1a61b; }
            .log-item[data-color="purple"] { border-left-color: #ad32ef; }
            .log-item[data-color="pink"] { border-left-color: #e57ea9; }
            .log-item[data-color="celeste"] { border-left-color: #82d8d0; }
            
            .log-item, .action-item {
                white-space: pre-wrap; /* 保留空白字符，包括换行 */
                word-wrap: break-word; /* 允许长单词换行 */
            }
            
            .log-item:hover {
                background-color: rgba(77, 166, 255, 0.1);
            }

            /* 滚动条优化 */
            ::-webkit-scrollbar {
                width: 6px;
            }
            
            ::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.1);
            }
            
            ::-webkit-scrollbar-thumb {
                background: rgba(100, 100, 100, 0.5);
                border-radius: 3px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: rgba(150, 150, 150, 0.7);
            }
            
            .player-log::-webkit-scrollbar-thumb {
                background: var(--accent);
            }

            /* ===== 中间区域：游戏区域 (47%) ===== */
            .middle-section {
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius);
                width: 47%;
                height: 100%;
                display: flex;
                flex-direction: column;
                border: 1px solid var(--border);
                overflow: hidden;
            }

            .middle-header {
                padding: 10px var(--panel-padding);
                height: 5%;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                font-size: 1.1rem;
                color: var(--text-primary);
                flex-shrink: 0;
            }

            .middle-header i {
                color: var(--accent);
            }

            .middle-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                padding: 0;
                border-radius: 10px;
                border: 1px solid #262626;
                margin-left: 9px;
                margin-right: 9px;
                margin-bottom: 8px;
                background-color: #171717;
            }

            .game-grid {
                display: flex;
                flex-direction: column;
                gap: var(--gap);
                padding: var(--gap);
                flex: 1;
                overflow-y: auto;
                max-height: 100%;
                min-height: 0;
            }

            /* 隐藏游戏网格滚动条 */
            .game-grid::-webkit-scrollbar {
                display: none;
            }

            .game-card {
                background-color: var(--bg-tertiary);
                border-radius: var(--border-radius);
                border: 1px solid var(--border);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                max-height: 60%;
                flex-shrink: 0;
                transition: max-height 0.3s ease;
            }

            .game-card:hover {
                border-color: var(--accent);
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
            }

            .game-card.collapsed {
                /* height: 50px;  */
                /* 收缩后的高度，等于标题栏高度 */
                max-height: 50px;
            }

            .game-header {
                padding: 8px var(--panel-padding);
                background-color: var(--bg-tertiary);
                /* border-bottom: 1px solid var(--border); */
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                user-select: none;
                transition: background-color 0.2s;
                flex-shrink: 0;
                height: 50px;
                box-sizing: border-box;
            }

            .game-header:hover {
                background-color: rgba(77, 166, 255, 0.1);
            }

            .game-header-left {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .game-title {
                font-size: 1rem;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .game-title i {
                color: var(--accent);
                width: 16px;
                text-align: center;
            }

            .game-indicator {
                color: var(--text-secondary);
                transition: transform 0.3s ease;
            }

            .game-card.collapsed .game-indicator {
                transform: rotate(-90deg);
            }

            .map-board-status {
                flex: 1;
                display: flex;
                overflow: hidden;
                min-height: 0;
                transition: 
                    opacity 0.3s ease;
                    /* transform 0.5s ease; */
                opacity: 1;
                /* transform: scaleY(1);
                transform-origin: top; */
            }

            .game-card.collapsed .map-board-status {
                opacity: 0;
                /* transform: scaleY(0); */
            }

            .game-stats {
                flex: 1;
                padding: var(--panel-padding);
                border-right: 1px solid var(--border);
                overflow-y: auto;
                background-color: var(--bg-elevated);
                min-height: 0;
            }

            /* 地图容器全宽样式 - 优化贴边 */
            .map-container-full {
                width: 100%;
                height: 100%;
                padding: 5px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: transparent;
                overflow: hidden;
                /* 确保容器有明确的尺寸 */
                /* min-height: 400px;  */
                /* 设置最小高度确保可见 */
            }

            #hex-grid-svg {
                display: block;
                width: 100%;
                min-height: 490px;
                /* flex-shrink: 0; */
            }

            /* 六边形样式优化 */
            .hexagon {
                fill: rgba(40, 40, 60, 0.7);
                stroke: rgb(219, 219, 219);
                stroke-width: 2;
                stroke-dasharray: 0;
                transition: all 0.1s ease;
                cursor: default;
                z-index: 0;
            }

            /* 水域地块使用虚线边框 */
            .hexagon.terrain-water {
                stroke-dasharray: 9, 9; /* 虚线样式：3px实线，3px间隔 */
                stroke-width: 1.5;
                stroke: rgba(255, 255, 255, 0.2);
            }

            /* 悬停效果优化 - 添加z-index提升 */
            .hexagon:hover {
                stroke: var(--accent) !important;
                stroke-width: 4 !important;
                stroke-dasharray: 0 !important;
                filter: brightness(1.1);
                /* 移除z-index，在SVG中无效 */
            }

            /* 地形颜色类 */
            .terrain-water { 
                fill: transparent; 
            }
            .terrain-plains { fill: #85491D; }
            .terrain-swamp { fill: #595959; }
            .terrain-lake { fill: #35a0d5; }
            .terrain-forest { fill: #37af37; }
            .terrain-mountain { fill: #a1a1a1; }
            .terrain-wasteland { fill: #cc2828; }
            .terrain-desert { fill: #e8e83d; }

            /* 调整六边形编号样式，使其位于六边形内偏上方 */
            .hex-number {
                font-family: Arial, sans-serif;
                font-size: 10px;
                font-weight: bold;
                fill: rgba(255, 255, 255, 0.9);
                text-anchor: middle;
                dominant-baseline: middle;
                pointer-events: none;
                user-select: none;
                text-shadow: 0 0 3px rgba(0, 0, 0, 0.85);
                transform: translateY(-8px); /* 向上偏移6像素 */
            }

            /* 六边形元素样式 */
            .hex-elements {
                opacity: 1;
                transition: all 0.3s ease;
                pointer-events: none; /* 防止元素干扰六边形点击事件 */
            }

            .hex-elements:hover {
                opacity: 1;
            }
            
            /* 回合信息卡片 */
            .round-info-status {
                padding: var(--panel-padding);
                opacity: 1;
                transition: opacity 0.3s ease;
            }

            .game-card.collapsed .round-info-status {
                opacity: 0;
            }

            .round-info-container {
                display: flex;
                gap: 20px;
                /* min-height: 300px; */
            }
            
            /* 左侧计分区 - 固定30%宽度 */
            .left-column {
                width: 30%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr;
                gap: 10px;
                /* column-gap: 0px;
                row-gap: 0px; */
                min-height: 100%;
            }
            
            .grid-cell {
                /* background-color: transparent; */
                /* border: 1px solid var(--border); */
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
                /* 确保图片填充整个单元格 */
                width: 100%;
                height: 100%;
                transition: all 0.3s ease;
            }
            
            .card-container {
                width: 100%;
                height: 100%;
                position: relative;
                transform-style: preserve-3d;
                transition: transform 0.6s;
            }

            .card-face {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .card-face.back {
                transform: rotateY(180deg);
            }

            /* 翻面状态 */
            .grid-cell.flipped .card-container {
                transform: rotateY(180deg);
            }

            /* 悬停时显示背面 */
            .grid-cell.flipped:hover .card-container {
                transform: rotateY(0deg);
            }

            /* 旋转边框效果 - 应用到当前回合 */
            .grid-cell.current-round {
                position: relative;
                z-index: 5;
                overflow: hidden;
                border-radius: 12px;
                padding: 6px;
                /* 添加内边距，创建图片与边框的间距 */
            }

            /* 旋转边框动画 */
            .grid-cell.current-round::before {
                content: '';    
                position: absolute;
                z-index: -1;
                left: -60%;
                top: -50%;
                width: 220%;
                height: 200%;
                background-color: #1a232a;
                background-repeat: no-repeat;
                background-position: 0 0;
                background-image: conic-gradient(transparent, rgba(0, 123, 255, 1), rgba(77, 166, 255, 1), transparent 30%);
                animation: rotate 6s linear infinite;
                border-radius: 12px;
            }

            /* 内部覆盖层，形成边框效果 */
            .grid-cell.current-round::after {
                content: '';
                position: absolute;
                z-index: -1;
                left: 2px;
                top: 2px;
                width: calc(100% - 4px);
                height: calc(100% - 4px);
                background: var(--bg-tertiary);
                border-radius: 12px;
            }

            /* 旋转动画 */
            @keyframes rotate {
                100% {
                    transform: rotate(1turn);
                }
            }

            /* 透明度变化动画（可选） */
            @keyframes opacityChange {
                50% {
                    opacity: 0.7;
                }
                100% {
                    opacity: 1;
                }
            }

            /* 确保回合标签在最上层 */
            .grid-cell.current-round .round-label {
                z-index: 30;
            }

            .grid-cell img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                /* padding: 5px; */
            }
            
            /* 第六回合格子的叠加容器 */
            .round-6 {
                position: relative;
            }

            .grid-cell.current-round.round-6 {
                position: relative;
                z-index: 1; /* 建立新的层叠上下文 */
            }
            
            .base-image, .overlay-image {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
                /* padding: 5px; */
            }
            
            /* 修复叠加图片尺寸 - 关键代码 */
            .grid-cell.current-round.round-6 .overlay-image {
                position: absolute;
                top: 6px; /* 与padding值匹配 */
                left: 6px; /* 与padding值匹配 */
                width: calc(100% - 12px); /* 100% - 左右padding */
                height: calc(100% - 12px); /* 100% - 上下padding */
                object-fit: contain;
                z-index: 20;
                display: block; /* 确保显示 */
                pointer-events: none;
            }

            /* 非强调状态下的叠加图片保持原样 */
            .grid-cell.round-6 .overlay-image {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: contain;
                z-index: 2;
                display: none; /* 默认隐藏 */
            }

            /* 回合标签 */
            .round-label {
                position: absolute;
                bottom: 0px;
                /* left: 1px; */
                font-size: 0.7rem;
                color: #ededed;
                background: rgba(0, 0, 0, 0.5);
                padding: 2px 4px;
                border-radius: 4px;
                z-index: 30; /* 确保标签在最上层 */
                pointer-events: none; /* 不拦截鼠标事件 */
            }
            
            /* 右侧奖励区 - 占剩余70%宽度 */
            .right-column {
                width: 70%;
                display: flex;
                gap: 10px;
                min-height: 100%;
                padding: 5px;
                align-items: stretch;
            }

            .bonus-cell {
                flex: 1;
                /* background-color: transparent; */
                /* border: 1px solid var(--border); */
                /* border-radius: 4px; */
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 0; /* 防止内容溢出 */
                position: relative; /* 为标签定位做准备 */
            }

            .bonus-cell img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                /* padding: 5px; */
            }
            
            /* 助推板标签 */
            .bonus-label {
                position: absolute;
                bottom: 6px;
                /* left: 0px; */
                font-size: 0.6rem;
                color: #ededed;
                background: rgba(0, 0, 0, 0.5);
                padding: 2px 4px;
                border-radius: 4px;
                z-index: 3;
            }
            
            
            /* 响应式调整 */
            @media (max-width: 768px) {
                .scoring-container {
                    flex-direction: column;
                    min-height: auto;
                }
                
                .left-column, .right-column {
                    width: 100%;
                }
            }
            /* ===== 右侧：全局信息区 (25%) ===== */
            .global-section {
                display: flex;
                flex-direction: column;
                gap: var(--gap);
                width: 25%;
                height: 100%;
            }
            
            .global-status {
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius);
                padding: 16px var(--panel-padding);
                height: flex;
                border: 1px solid var(--border);
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .status-title {
                font-size: 0.95rem;
                color: var(--accent);
                margin-bottom: 10px;
                display: flex;
                align-items: baseline;
                gap: 8px;
                font-weight: 700;
            }
            
            .status-title i {
                color: var(--accent);
            }
            
            .status-content {
                font-size: 1.1rem;
                color: var(--text-primary);
                line-height: 1.6;
                overflow: hidden;
                display: flex;
                white-space: pre-wrap; /* 保留空白字符，包括换行 */
                word-wrap: break-word; /* 允许长单词换行 */
            }

            .action-section {
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius);
                flex: 1;
                display: flex;
                flex-direction: column;
                border: 1px solid var(--border);
                overflow: hidden;
            }
            
            .action-header {
                padding: 8px var(--panel-padding);
                background-color: var(--bg-tertiary);
                border-bottom: 1px solid var(--border);
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                min-height: 36px;
            }
            
            .action-title {
                font-size: 1rem;
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .action-title i {
                color: var(--accent);
            }
            
            .action-content {
                flex: 1;
                padding: var(--panel-padding);
                overflow-y: auto;
                font-size: 0.9rem;
                line-height: 1.5;
                color: var(--text-secondary);
                background-color: var(--bg-primary);
            }
            
            .action-item {
                background-color: var(--bg-tertiary);
                border-left: 4px solid var(--accent); /* 默认颜色 */
                padding: 10px;
                margin-bottom: 8px;
                border-radius: 0 2px 2px 0;
                font-family: 'Consolas', monospace;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .action-item[data-color="red"] { border-left-color: #cc2828; }
            .action-item[data-color="green"] { border-left-color: #37af37; }
            .action-item[data-color="blue"] { border-left-color: #35a0d5; }
            .action-item[data-color="yellow"] { border-left-color: #e8e83d; }
            .action-item[data-color="grey"] { border-left-color: #a1a1a1; }
            .action-item[data-color="brown"] { border-left-color: #85491D; }
            .action-item[data-color="black"] { border-left-color: #595959; }
            .action-item[data-color="white"] { border-left-color: #ffffff; }
            
            .global-input {
                background-color: var(--bg-secondary);
                border-radius: var(--border-radius);
                padding: var(--panel-padding);
                height: 70px;
                border: 1px solid var(--border);
                display: flex;
                flex-direction: column;
            }
            
            .input-group {
                display: flex;
                gap: 8px;
                flex: 1;
            }
            
            #command {
                flex: 1;
                padding: 10px 12px;
                border: 1px solid var(--border);
                border-radius: 4px;
                background-color: var(--bg-primary);
                color: var(--text-primary);
                font-size: 0.95rem;
                font-family: inherit;
                outline: none;
                transition: border-color 0.2s;
            }
            
            #command:focus {
                border-color: var(--accent);
            }
            
            .send-btn {
                background-color: var(--accent);
                color: white;
                border: none;
                width: 44px;
                border-radius: 4px;
                font-size: 1.05rem;
                cursor: pointer;
                transition: background-color 0.2s;
                flex-shrink: 0;
            }
            
            .send-btn:hover {
                background-color: #0069d9;
            }
            
            /* 滚动条优化 */
            ::-webkit-scrollbar {
                width: 6px;
            }
            
            ::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.1);
            }
            
            ::-webkit-scrollbar-thumb {
                background: rgba(100, 100, 100, 0.5);
                border-radius: 3px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: rgba(150, 150, 150, 0.7);
            }
            
            .player-log::-webkit-scrollbar-thumb,
            .action-content::-webkit-scrollbar-thumb {
                background: var(--accent);
            }
        
        </style>
    </head>
    <body>
        <div class="container">
            <div class="main-container">
                <!-- 左侧：玩家监控区 (35%) -->
                <div class="players-monitor">
                    <div class="monitor-header">
                        <i class="fas fa-users"></i>
                        <div>玩家监控</div>
                    </div>
                    <div class="monitor-content">
                        <div class="player-grid" id="player-grid">
                            {% for i in range(1, panel_count+1) %}
                            <div class="player-card">
                                <!-- 修改玩家标题栏部分 -->
                                <div class="player-header" onclick="toggleCard(this)">
                                    <div class="player-header-left">
                                        <!-- 规划卡显示（首次传递后显示） -->
                                        <div class="planning-card-indicator" 
                                            id="player{{i}}-planning-card"
                                            style="display: none;">
                                            <div class="planning-card-circle"></div>
                                        </div>
                                        
                                        <div class="player-title">
                                            <span id="player{{i}}-title">玩家 {{ i }}</span>
                                            <!-- 派系显示（首次传递后显示） -->
                                            <span class="faction-badge" 
                                                id="player{{i}}-faction"
                                                style="display: none;"></span>
                                        </div>
                                    </div>
                                    <div class="player-score" id="player{{i}}-score">20</div>
                                </div>
                                <div class="player-status">
                                    <div class="player-stats">
                                        <!-- 第一行：资源数量 -->
                                        <div class="stat-row">
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-coins stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-money">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-cube stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-mineral">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-user stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-mibao">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 第二行：书籍数量 -->
                                        <div class="stat-row">
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-university stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-bank">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-gavel stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-law">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-cog stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-engineering">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-heartbeat stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-medical">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 第三行：三区魔力 -->
                                        <div class="stat-row">
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <div class="icon-stack">
                                                        <i class="fa-solid fa-circle icon-background"></i>
                                                        <i class="fa-solid fa-1 icon-foreground"></i>
                                                    </div>
                                                    <span class="stat-value" id="player{{i}}-magic1">5</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <div class="icon-stack">
                                                        <i class="fa-solid fa-circle icon-background"></i>
                                                        <i class="fa-solid fa-2 icon-foreground"></i>
                                                    </div>
                                                    <span class="stat-value" id="player{{i}}-magic2">7</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <div class="icon-stack">
                                                        <i class="fa-solid fa-circle icon-background"></i>
                                                        <i class="fa-solid fa-3 icon-foreground"></i>
                                                    </div>
                                                    <span class="stat-value" id="player{{i}}-magic3">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 第四行：其他状态 -->
                                        <div class="stat-row">
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-city stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-cities">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-ship stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-navigation">0</span>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-content">
                                                    <i class="fas fa-digging stat-icon"></i>
                                                    <span class="stat-value" id="player{{i}}-shovel">3</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="player-log" id="player-log-{{ i }}">
                                        <!-- 日志内容 -->
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- 中间区域 (35%) -->
                <!-- 修改中间区域部分 -->
                <div class="middle-section">
                    <div class="middle-header">
                        <i class="fas fa-gamepad"></i>
                        <div>游戏区域</div>
                    </div>
                    <div class="middle-content">
                        <div class="game-grid" id="game-grid">
                            <!-- 游戏版图卡片 -->
                            <div class="game-card">
                                <div class="game-header" onclick="toggleGameCard(this)">
                                    <div class="game-header-left">
                                        <div class="game-title">
                                            <i class="fas fa-map"></i>
                                            <span>游戏版图</span>
                                        </div>
                                    </div>
                                    <div class="game-indicator">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div class="map-board-status">
                                    <div class="map-container-full">
                                        <svg id="hex-grid-svg" width="100%" height="100%" viewBox="0 0 800 640" preserveAspectRatio="xMidYMid slice">
                                            <!-- 六边形将通过JavaScript生成 -->
                                            <!-- 添加元素层，用于放置图标 -->
                                            <g id="hex-elements"></g>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <!-- 回合信息卡片 -->
                            <div class="game-card">
                                <div class="game-header" onclick="toggleGameCard(this)">
                                    <div class="game-header-left">
                                        <div class="game-title">
                                            <i class="fas fa-flag-checkered"></i>
                                            <span>回合信息</span>
                                        </div>
                                    </div>
                                    <div class="game-indicator">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div class="round-info-status">
                                    <div class="round-info-container">
                                        <!-- 左侧计分区 -->
                                        <div class="left-column" id="left-scoring-grid">
                                            <!-- 第1回合 -->
                                            <div class="grid-cell round-1" data-round="1">
                                                <span class="round-label">第 1 回合</span>
                                                <div class="card-container">
                                                    <div class="card-face front">
                                                        <img src="images/scoring/-1.png" alt="计分图标" class="scoring-image">
                                                    </div>
                                                    <div class="card-face back">
                                                        <img src="images/scoring/0.png" alt="计分图标背面" class="scoring-image">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 第4回合 -->
                                            <div class="grid-cell round-4" data-round="4">
                                                <span class="round-label">第 4 回合</span>
                                                <div class="card-container">
                                                    <div class="card-face front">
                                                        <img src="images/scoring/-1.png" alt="计分图标" class="scoring-image">
                                                    </div>
                                                    <div class="card-face back">
                                                        <img src="images/scoring/0.png" alt="计分图标背面" class="scoring-image">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 第2回合 -->
                                            <div class="grid-cell round-2" data-round="2">
                                                <span class="round-label">第 2 回合</span>
                                                <div class="card-container">
                                                    <div class="card-face front">
                                                        <img src="images/scoring/-1.png" alt="计分图标" class="scoring-image">
                                                    </div>
                                                    <div class="card-face back">
                                                        <img src="images/scoring/0.png" alt="计分图标背面" class="scoring-image">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 第5回合 -->
                                            <div class="grid-cell round-5" data-round="5">
                                                <span class="round-label">第 5 回合</span>
                                                <div class="card-container">
                                                    <div class="card-face front">
                                                        <img src="images/scoring/-1.png" alt="计分图标" class="scoring-image">
                                                    </div>
                                                    <div class="card-face back">
                                                        <img src="images/scoring/0.png" alt="计分图标背面" class="scoring-image">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 第3回合 -->
                                            <div class="grid-cell round-3" data-round="3">
                                                <span class="round-label">第 3 回合</span>
                                                <div class="card-container">
                                                    <div class="card-face front">
                                                        <img src="images/scoring/-1.png" alt="计分图标" class="scoring-image">
                                                    </div>
                                                    <div class="card-face back">
                                                        <img src="images/scoring/0.png" alt="计分图标背面" class="scoring-image">
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 第6回合（支持叠加） -->
                                            <div class="grid-cell round-6" data-round="6">
                                                <span class="round-label">第 6 回合</span>
                                                <div class="card-container">
                                                    <div class="card-face front">
                                                        <!-- 基础图片 -->
                                                        <img src="images/scoring/-1.png" alt="基础计分图标" class="base-image">
                                                    </div>
                                                    <div class="card-face back">
                                                        <!-- 背面图片 -->
                                                        <img src="images/scoring/0.png" alt="计分图标背面" class="scoring-image">
                                                    </div>
                                                </div>
                                                <!-- 叠加图片 - 作为独立元素 -->
                                                <img src="" alt="叠加奖励图标" class="overlay-image">
                                            </div>
                                        </div>
                                        
                                        <!-- 右侧奖励区 -->
                                        <div class="right-column" id="right-bonus-grid">
                                            <!-- 动态生成奖励单元格 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 战术地图卡片 -->
                            <div class="game-card">
                                <div class="game-header" onclick="toggleGameCard(this)">
                                    <div class="game-header-left">
                                        <div class="game-title">
                                            <i class="fas fa-map"></i>
                                            <span>战术地图</span>
                                        </div>
                                    </div>
                                    <div class="game-indicator">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div class="game-status">
                                    <div class="game-stats">
                                        <div class="map-container">
                                            <!-- 战术地图占位符 -->
                                            <div class="map-placeholder">
                                                <i class="fas fa-map-marked-alt"></i>
                                                <div>战术地图区域</div>
                                                <div style="font-size: 0.9rem; margin-top: 8px; color: var(--text-secondary);">
                                                    此区域将显示游戏地图和战术信息
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="game-log" id="game-log-tactical">
                                        <!-- 战术日志将显示在这里 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：全局信息区 (30%) -->
                <div class="global-section">
                    <!-- 顶部全局状态 -->
                    <div class="global-status">
                        <div class="status-title">
                            <i class="fas fa-info-circle"></i>
                            <div>对局状态</div>
                        </div>
                        <div class="status-content" id="global-status-content">所有玩家已就绪，对局即将开始</div>
                    </div>
                    
                    <!-- 可选行动区 -->
                    <div class="action-section">
                        <div class="action-header">
                            <div class="action-title">
                                <i class="fas fa-play-circle"></i>
                                <div>可选行动</div>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">共<span id="action-count">0</span>条</div>
                        </div>
                        <div id="action-content" class="action-content">
                            <!-- 行动日志将显示在这里 -->
                        </div>
                    </div>
                    
                    <!-- 底部输入区 -->
                    <div class="global-input">
                        <div class="input-group">
                            <input type="text" id="command" placeholder="输入行动编号..." autofocus>
                            <button class="send-btn" onclick="sendCommand()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // 切换玩家卡片展开/收缩状态
            function toggleCard(header) {
                const card = header.parentElement;
                card.classList.toggle('collapsed');
            }
            
            // 切换游戏卡片展开/收缩状态
            function toggleGameCard(header) {
                const card = header.parentElement;
                card.classList.toggle('collapsed');
            }

            // 连接所有数据流
            const eventSources = {};
            
            // 1. 游戏状态流
            eventSources.status = new EventSource('/stream/status');
            eventSources.status.onmessage = e => {
                if (e.data.includes(":heartbeat")) return;
                try {
                    const data = JSON.parse(JSON.parse(e.data).content)
                    if ('type' in data && data.type === 'global_state') {
                        document.getElementById('global-status-content').textContent = data.content;
                    } else if ('type' in data && data.type === 'terrain_update') {
                        // 处理地形更新
                        const terrainData = data.data;
                        setHexTerrain(terrainData.row, terrainData.col, terrainData.terrain_type);
                    } else if ('type' in data && data.type === 'element_placement') {
                        // 处理元素放置
                        const placementData = data.data;
                        placeElement(
                            placementData.hex_row,
                            placementData.hex_col,
                            placementData.x,
                            placementData.y,
                            placementData.mode
                        );
                    } else if ('type' in data && data.type === 'round_scoring') {
                        // 处理回合计分图片设置
                        const scoringData = data.data;
                        setRoundScoring(scoringData.round, scoringData.x);
                    } else if ('type' in data && data.type === 'final_round_bonus') {
                        // 处理第6回合叠加奖励
                        const bonusData = data.data;
                        setFinalRoundBonus(bonusData.x);
                    } else if ('type' in data && data.type === 'bonus_columns') {
                        // 处理助推板块更新
                        const columnsData = data.data;
                        setBonusColumns(columnsData.x_list);
                    } else if ('type' in data && data.type === 'round_scoring_update') {
                        // 回合计分板翻面
                        const roundData = data.data;
                        RoundScoringUpdate(roundData.round);
                    }
                } catch (err) {
                    console.error("全局状态解析错误:", err);
                }
            };

            // 2. 可选行动流
            // 修改可选行动流处理，支持自定义颜色
            eventSources.actions = new EventSource('/stream/actions');
            eventSources.actions.onmessage = e => {
                if (e.data.includes(":heartbeat")) return;
                try {
                    const data = JSON.parse(JSON.parse(e.data).content);
                    const actionContent = document.getElementById('action-content');
                    const item = document.createElement('div');
                    item.className = 'action-item';
                    item.textContent = data.content;
                    // 设置自定义颜色
                    if (data.color) {
                        item.setAttribute('data-color', data.color);
                    }
                    actionContent.appendChild(item);
                    actionContent.scrollTop = actionContent.scrollHeight;
                    
                    const countElement = document.getElementById('action-count');
                    countElement.textContent = parseInt(countElement.textContent) + 1;
                } catch (err) {
                    console.error("行动日志解析错误:", err);
                }
            };
            
            // 3. 玩家日志与状态流
            // 修改玩家日志流处理，支持自定义颜色
            for (let i = 1; i <= {{ panel_count }}; i++) {
                eventSources[`player${i}`] = new EventSource(`/stream/player${i}`);
                eventSources[`player${i}`].onmessage = e => {
                    if (e.data.includes(":heartbeat")) return;
                    try {
                        const data = JSON.parse(JSON.parse(e.data).content);
                        if ('type' in data && data.type === 'log_info') {
                            const logPanel = document.getElementById(`player-log-${i}`);
                            if (logPanel) {
                                const item = document.createElement('div');
                                item.className = 'log-item';
                                item.textContent = data.content;
                                // 设置自定义颜色
                                if (data.color) {
                                    item.setAttribute('data-color', data.color);
                                }
                                logPanel.appendChild(item);
                                logPanel.scrollTop = logPanel.scrollHeight;
                            }
                        } else if ('type' in data && data.type === 'state_update') {
                            // 处理状态更新
                            handlePlayerStateUpdate(data.data);
                        }
                    } catch (err) {
                        console.error(`玩家${i}消息解析错误:`, err);
                    }
                };
            }
            
            // 发送命令函数
            function sendCommand() {
                const input = document.getElementById('command');
                const cmd = input.value; // 直接获取值，不移除空白
                
                // 移除空值检查，允许发送空字符串
                // if (!cmd) return;  // 注释掉或删除这行
                
                fetch('/input', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `command=${encodeURIComponent(cmd)}`
                }).then(() => {
                    input.value = '';
                    input.focus();
                }).catch(err => {
                    console.error("命令发送失败:", err);
                });
            }
                    
            // 回车键支持
            document.getElementById('command').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendCommand();
            });
            
            // 优雅关闭连接
            window.addEventListener('beforeunload', () => {
                Object.values(eventSources).forEach(es => es.close());
            });

            // 处理玩家状态更新
            function handlePlayerStateUpdate(updateData) {
                const playerId = updateData.player_id;
                const updates = updateData.updates;
                
                // 更新数值字段
                const numericFields = {
                    'money': 'money',
                    'ore': 'mineral',
                    'meeple': 'mibao',
                    'bank_book': 'bank',
                    'law_book': 'law',
                    'engineering_book': 'engineering',
                    'medical_book': 'medical',
                    'magics_1': 'magic1',
                    'magics_2': 'magic2',
                    'magics_3': 'magic3',
                    'city_amount': 'cities',
                    'navigation_level': 'navigation',
                    'shovel_level': 'shovel'
                };
                
                // 更新对应的DOM元素
                for (const [backendField, frontendId] of Object.entries(numericFields)) {
                    if (backendField in updates) {
                        const element = document.getElementById(`player${playerId}-${frontendId}`);
                        if (element) {
                            element.textContent = updates[backendField];
                        }
                    }
                }
                
                // 更新标题栏特殊字段
                if ('score' in updates) {
                    const scoreElement = document.getElementById(`player${playerId}-score`);
                    if (scoreElement) {
                        scoreElement.textContent = updates.score;
                    }
                }
                
                // 更新派系显示
                if ('faction' in updates) {
                    const factionElement = document.getElementById(`player${playerId}-faction`);
                    if (factionElement) {
                        if (updates.faction) {
                            factionElement.textContent = updates.faction;
                            factionElement.style.display = 'inline';
                        } else {
                            factionElement.style.display = 'none';
                        }
                    }
                }
                
                // 更新规划卡显示
                if ('planning_card' in updates) {
                    const planningCardElement = document.getElementById(`player${playerId}-planning-card`);
                    if (planningCardElement) {
                        if (updates.planning_card) {
                            // 显示规划卡，设置颜色
                            const circle = planningCardElement.querySelector('.planning-card-circle');
                            if (circle) {
                                // 根据规划卡类型设置颜色
                                const colorMap = {
                                    "森林": "#37af37",    // 森林 - 绿色
                                    "湖泊": "#35a0d5",    // 湖泊 - 蓝色
                                    "沙漠": "#e8e83d",    // 沙漠 - 黄色
                                    "山脉": "#a1a1a1",    // 山地 - 灰色
                                    "平原": "#85491D",    // 平原 - 棕色
                                    "沼泽": "#595959",    // 沼泽 - 黑色
                                    "荒地": "#cc2828",    // 荒地 - 红色
                                };
                                circle.style.backgroundColor = colorMap[updates.planning_card] || "#ffffff";
                            }
                            planningCardElement.style.display = 'flex';
                        } else {
                            planningCardElement.style.display = 'none';
                        }
                    }
                }
            }
            
            // 地形类型映射
            const TERRAIN_TYPES = {
                0: "water",     // 水域
                1: "plains",    // 平原
                2: "swamp",     // 沼泽
                3: "lake",      // 湖泊
                4: "forest",    // 森林
                5: "mountain",  // 山脉
                6: "wasteland", // 荒地
                7: "desert"     // 沙漠
            };

            // 地形颜色映射
            const TERRAIN_COLORS = {
                0: "transparent",   // 水域 - 透明
                1: "#85491D",       // 平原 - 棕色
                2: "#595959",       // 沼泽 - 黑色
                3: "#35a0d5",       // 湖泊 - 蓝色
                4: "#37af37",       // 森林 - 绿色
                5: "#a1a1a1",       // 山脉 - 灰色
                6: "#cc2828",       // 荒地 - 红色
                7: "#e8e83d"        // 沙漠 - 黄色
            };

            // 生成六边形地图网格 - 优化居中效果
            function generateHexMap() {
                const svg = document.getElementById('hex-grid-svg');
                if (!svg) return;
                
                svg.innerHTML = ''; // 清空现有内容
                
                // 创建元素层
                const elementsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                elementsLayer.setAttribute('id', 'hex-elements');
                elementsLayer.setAttribute('class', 'hex-elements');

                const rows = 9;  // A-I
                const cols = 13; // 1-13
                const hexSize = 33.5; // 固定六边形大小
                
                // 计算六边形的顶点坐标
                function getHexPoints(x, y, size) {
                    const points = [];
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i - Math.PI/6;
                        const px = x + size * Math.cos(angle);
                        const py = y + size * Math.sin(angle);
                        points.push(`${px},${py}`);
                    }
                    return points.join(' ');
                }
                
                // 行字母映射
                const rowLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'];
                
                // 计算水平和垂直间距
                const horizontalSpacing = hexSize * Math.sqrt(3);
                const verticalSpacing = hexSize * 1.5;
                
                // 计算网格总尺寸
                const gridWidth = cols * horizontalSpacing + hexSize;
                const gridHeight = rows * verticalSpacing + hexSize;
                
                // 设置SVG的viewBox为网格总尺寸
                svg.setAttribute('viewBox', `0 0 ${gridWidth} ${gridHeight}`);
                svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                
                // 计算起始位置 - 精确居中算法
                // 由于preserveAspectRatio="xMidYMid meet"会自动居中，我们从(0,0)开始绘制
                const startX = hexSize;
                const startY = hexSize + 5;
                
                // 创建组元素，用于整体控制
                const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                gridGroup.setAttribute('class', 'hex-grid-group');
                
                // 生成六边形
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        // 偶数行偏移
                        const xOffset = (row % 2 === 0) ? 0 : horizontalSpacing / 2;
                        
                        // 计算中心坐标
                        const centerX = startX + col * horizontalSpacing + xOffset;
                        const centerY = startY + row * verticalSpacing;
                        
                        // 生成编号
                        const rowLetter = rowLetters[row];
                        const colNumber = col + 1;
                        const hexId = `${rowLetter}${colNumber}`;
                        
                        // 创建六边形
                        const hexagon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                        hexagon.setAttribute('class', 'hexagon');
                        hexagon.setAttribute('id', `hex-${hexId}`);
                        hexagon.setAttribute('points', getHexPoints(centerX, centerY, hexSize));
                        hexagon.setAttribute('data-position', hexId);
                        hexagon.setAttribute('data-row', row);
                        hexagon.setAttribute('data-col', col);
                        hexagon.setAttribute('data-terrain', '0');
                        
                        // 设置默认颜色（水域）
                        hexagon.setAttribute('fill', TERRAIN_COLORS[0]);
                        hexagon.classList.add('terrain-water');
                        
                        // 添加悬停事件，实现置顶效果
                        hexagon.addEventListener('mouseover', function() {
                            // 将当前六边形移动到SVG元素的最后，确保它在最上层
                            svg.appendChild(this);
                            
                            // 同时移动对应的文本标签，确保文本也在最上层
                            const textId = `text-${hexId}`;
                            const textElement = document.getElementById(textId);
                            if (textElement) {
                                svg.appendChild(textElement);
                            }
                            // 确保建筑元素层始终在最顶层
                            const elementsLayer = document.getElementById('hex-elements');
                            if (elementsLayer) {
                                this.parentNode.appendChild(elementsLayer);
                            }
                        });
                        
                        hexagon.addEventListener('mouseout', function() {
                            this.classList.remove('hovered');
                        });
                        
                        // 创建编号文本
                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('class', 'hex-number');
                        text.setAttribute('id', `text-${hexId}`);
                        text.setAttribute('x', centerX);
                        text.setAttribute('y', centerY - 9); // 向上偏移
                        text.textContent = hexId;
                        
                        // 添加到组
                        gridGroup.appendChild(hexagon);
                        gridGroup.appendChild(text);
                    }
                }
                
                // 将组添加到SVG
                svg.appendChild(gridGroup);

                // 在生成六边形后，将元素层添加到SVG
                svg.appendChild(elementsLayer); // 元素层在六边形之上
                
                // 应用初始地形
                applyInitialTerrain();
            }
            
            // 应用初始地形
            function applyInitialTerrain() {
                const initialTerrain = [
                    [4,0,3,2,1,6,5,0,3,2,1,7,0],
                    [5,0,0,4,3,4,7,0,4,5,3,0,2],
                    [6,3,2,0,5,1,2,0,0,6,0,0,6],
                    [7,5,6,0,7,6,0,2,0,0,1,5,4],
                    [1,4,1,7,0,0,0,4,5,3,6,7,1],
                    [2,0,0,0,3,5,0,7,1,0,2,3,6],
                    [3,0,1,2,0,4,1,0,0,0,0,0,0],
                    [0,7,3,0,6,2,7,6,2,3,4,2,0],
                    [4,5,6,0,7,5,1,3,4,5,6,7,1]
                ];
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 13; col++) {
                        setHexTerrain(row, col, initialTerrain[row][col]);
                    }
                }
            }

            // 设置地形函数
            function setHexTerrain(row, col, terrainType) {
                const hex = document.querySelector(`.hexagon[data-row="${row}"][data-col="${col}"]`);
                if (hex && TERRAIN_COLORS[terrainType] !== undefined) {
                    // 移除旧的地形类
                    const terrainClasses = Object.values(TERRAIN_TYPES).map(t => `terrain-${t}`);
                    hex.classList.remove(...terrainClasses);
                    
                    // 添加新的地形类和颜色
                    hex.classList.add(`terrain-${TERRAIN_TYPES[terrainType]}`);
                    hex.setAttribute('fill', TERRAIN_COLORS[terrainType]);
                    hex.setAttribute('data-terrain', terrainType);
                    
                    // 特殊处理：水域使用虚线边框
                    if (terrainType === 0) {
                        hex.style.strokeDasharray = "4,2";
                    } else {
                        hex.style.strokeDasharray = "none";
                    }
                    
                    return true;
                }
                return false;
            }

            // 预加载函数
            function preloadImage(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = url;
                });
            }

            // 放置建筑元素到六边形
            async function placeElement(hexRow, hexCol, planningCardId, buildingType, mode) {
                // 计算位置ID (A1, B2等)
                const rowLetter = String.fromCharCode(65 + hexRow); // 0->A, 1->B等
                const colNumber = hexCol + 1;
                const positionId = `${rowLetter}${colNumber}`;
                
                // 获取对应的六边形元素
                const hexElement = document.getElementById(`hex-${positionId}`);
                if (!hexElement) {
                    console.error(`六边形 ${positionId} 不存在`);
                    return;
                }
                
                // 获取元素层
                const elementsLayer = document.getElementById('hex-elements');
                if (!elementsLayer) {
                    console.error('元素层不存在');
                    return;
                }
                
                // 获取六边形的中心坐标
                const bbox = hexElement.getBBox();
                const centerX = bbox.x + bbox.width / 2;
                const bottomY = bbox.y + bbox.height * 0.85;
                
                // 替换模式：移除该位置的所有现有元素
                if (mode === 'replace') {
                    document.querySelectorAll(`.hex-elements[data-position="${positionId}"]`).forEach(el => {
                        el.remove();
                    });
                }
                
                // 创建建筑图片
                const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                image.setAttribute('class', 'hex-elements');
                image.setAttribute('data-position', positionId);
                image.setAttribute('data-card-id', planningCardId);
                image.setAttribute('data-building-type', buildingType);
            
                try {
                    // 预加载图片获取原始尺寸
                    const imgUrl = `/images/buildings/${planningCardId}-${buildingType}.png`;
                    const preloadedImg = await preloadImage(imgUrl);
                    
                    // 计算50%的尺寸
                    const scaledWidth = preloadedImg.naturalWidth * 0.25;
                    const scaledHeight = preloadedImg.naturalHeight * 0.25;
                    
                    // 直接设置正确尺寸
                    image.setAttribute('x', centerX - scaledWidth/2);
                    image.setAttribute('y', bottomY - scaledHeight);
                    image.setAttribute('width', scaledWidth);
                    image.setAttribute('height', scaledHeight);
                    image.setAttribute('href', imgUrl);
                    
                } catch (error) {
                    console.error(`预加载图片失败: ${planningCardId}-${buildingType}.png`, error);
                    // 使用错误指示
                    image.setAttribute('href', 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="red" stroke-width="2"/><line x1="8" y1="8" x2="16" y2="16" stroke="red" stroke-width="2"/><line x1="16" y1="8" x2="8" y2="16" stroke="red" stroke-width="2"/></svg>');
                }

                // 添加加载事件处理
                image.addEventListener('load', () => {
                    console.log(`已加载建筑: ${planningCardId}-${buildingType}.png`);
                }); 
                
                image.addEventListener('error', (e) => {
                    console.error(`加载建筑图片失败: ${planningCardId}-${buildingType}.png`, e);
                    // 添加错误指示
                    image.setAttribute('href', 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="red" stroke-width="2"/><line x1="8" y1="8" x2="16" y2="16" stroke="red" stroke-width="2"/><line x1="16" y1="8" x2="8" y2="16" stroke="red" stroke-width="2"/></svg>');
                });
                
                // 添加到元素层
                elementsLayer.appendChild(image);
                
                return true;
            }
            
            // 回合到网格位置的映射
            const ROUND_POSITIONS = {
                1: { row: 0, col: 0 },
                2: { row: 1, col: 0 },
                3: { row: 2, col: 0 },
                4: { row: 0, col: 1 },
                5: { row: 1, col: 1 },
                6: { row: 2, col: 1 }
            };

            // 全局状态，记录每个回合的当前图片和是否翻面
            const roundStates = {};

            // 初始化回合状态
            function initializeRoundStates() {
                for (let round = 1; round <= 6; round++) {
                    roundStates[round] = {
                        currentX: -1, // 当前显示的图片编号
                        actualX: -1,  // 实际应该显示的图片编号
                        isFlipped: false // 是否翻面
                    };
                }
            }
            
            // 1. 设置左侧回合计分板的函数
            // 修改后的设置回合计分板函数
            function setRoundScoring(round, x) {
                // 验证参数
                if (round < 1 || round > 6) {
                    console.error('回合数必须在1-6之间');
                    return false;
                }
                
                if (x < -1 || x > 12) {
                    console.error('计分图片编号必须在-1-12之间');
                    return false;
                }
                
                // 获取对应回合的元素
                const roundElement = document.querySelector(`.round-${round}`);
                if (!roundElement) {
                    console.error(`找不到第${round}回合的元素`);
                    return false;
                }
                
                // 更新状态
                roundStates[round].actualX = x;
                roundStates[round].currentX = x; // 默认显示实际图片
                
                // 设置图片
                const frontImage = roundElement.querySelector('.card-face.front img');
                
                if (frontImage) {
                    frontImage.src = `images/scoring/${x}.png`;
                    frontImage.alt = `第${round}回合计分图标 ${x}`;
                    console.log(`设置第${round}回合计分图片: ${x}.png`);
                    return true;
                }
                
                return false;
            }

            // 新增函数：翻面显示0号图片
            function RoundScoringUpdate(round) {
                if (round < 0 || round > 6) {
                    console.error('回合数必须在1-6之间');
                    return false;
                } else {
                    
                    if (round >= 1 && round <= 6) {
                        const roundElement = document.querySelector(`.round-${round}`);
                        if (!roundElement) {
                            console.error(`找不到第${round}回合的元素`);
                            return false;
                        }
                        
                        // 更新状态
                        roundStates[round].currentX = 0;
                        roundStates[round].isFlipped = true;
                        
                        // 添加翻面类
                        roundElement.classList.add('flipped');
                        
                        console.log(`第${round}回合已翻面显示0号图片`);
                        
                    }

                    if (round >= 0 && round <= 5) {
                        // 自动强调当前回合
                        emphasizeRound(round + 1);
                    }

                    return true;
                }
                
            }

            // 新增函数：强调指定回合
            // 强调指定回合
            function emphasizeRound(round) {
                // 移除之前强调的回合
                if (currentEmphasizedRound > 0) {
                    const prevElement = document.querySelector(`.round-${currentEmphasizedRound}`);
                    if (prevElement) {
                        prevElement.classList.remove('current-round');
                    }
                }
                
                // 如果设置为0，清除所有强调
                if (round === 0) {
                    currentEmphasizedRound = 0;
                    return true;
                }
                
                // 设置新的强调回合
                const currentElement = document.querySelector(`.round-${round}`);
                if (currentElement) {
                    currentElement.classList.add('current-round');
                    currentEmphasizedRound = round;
                    return true;
                }
                
                return false;
            }

            // 新增函数：清除所有回合的强调效果
            // 清除所有强调
            function clearAllEmphasis() {
                for (let round = 1; round <= 6; round++) {
                    const element = document.querySelector(`.round-${round}`);
                    if (element) {
                        element.classList.remove('current-round');
                    }
                }
                currentEmphasizedRound = 0;
            }


            // 新增函数：取消翻面，显示实际图片
            // function unflipRound(round) {
            //     if (round < 1 || round > 6) {
            //         console.error('回合数必须在1-6之间');
            //         return false;
            //     }
                
            //     const roundElement = document.querySelector(`.round-${round}`);
            //     if (!roundElement) {
            //         console.error(`找不到第${round}回合的元素`);
            //         return false;
            //     }
                
            //     // 更新状态
            //     roundStates[round].currentX = roundStates[round].actualX;
            //     roundStates[round].isFlipped = false;
                
            //     // 移除翻面类
            //     roundElement.classList.remove('flipped');
                
            //     console.log(`第${round}回合已取消翻面，显示实际图片`);
            //     return true;
            // }
            
            // 2. 设置第6回合的叠加奖励图片
            // 修改设置第6回合的叠加奖励图片函数
            function setFinalRoundBonus(x) {
                // 验证参数
                if (x < 13 || x > 16) {
                    console.error('叠加奖励图片编号必须在13-16之间');
                    return false;
                }
                
                // 获取第6回合的元素
                const round6Element = document.querySelector('.round-6');
                if (!round6Element) {
                    console.error('找不到第6回合的元素');
                    return false;
                }
                
                // 设置叠加图片
                const overlayImage = round6Element.querySelector('.overlay-image');
                if (overlayImage) {
                    overlayImage.src = `images/scoring/${x}.png`;
                    overlayImage.alt = `第6回合奖励图标 ${x}`;
                    overlayImage.style.display = 'block';

                    // 强制显示叠加图片
                    overlayImage.style.display = 'block';
                    overlayImage.style.visibility = 'visible';
                    overlayImage.style.opacity = '1';
                    overlayImage.style.zIndex = '20'; // 确保层级最高

                    console.log(`设置第6回合叠加奖励图片: ${x}.png`);
                    return true;
                }
                
                
                return false;
            }
            // 添加调试函数检查层级
            function debugRound6Layers() {
                console.log('=== 第六回合层级调试 ===');
                
                const round6 = document.querySelector('.round-6');
                if (!round6) {
                    console.error('找不到第六回合元素');
                    return;
                }
                
                const elements = round6.querySelectorAll('*');
                elements.forEach(el => {
                    const style = window.getComputedStyle(el);
                    console.log(el.className, {
                        zIndex: style.zIndex,
                        display: style.display,
                        visibility: style.visibility,
                        opacity: style.opacity,
                        position: style.position
                    });
                });
            }

            // 在设置叠加图片后调用调试
            function setFinalRoundBonusWithDebug(x) {
                const result = setFinalRoundBonus(x);
                setTimeout(debugRound6Layers, 100); // 延迟100ms后检查层级
                return result;
            }
                        
            // 3. 全量更新右侧的回合助推板块图片
            function setBonusColumns(xList) {
                // 验证参数
                if (!Array.isArray(xList)) {
                    console.error('参数必须是数组');
                    return false;
                }
                
                // 验证数组中的每个值
                for (let i = 0; i < xList.length; i++) {
                    if (xList[i] < 0 || xList[i] > 20) {
                        console.error(`助推板块图片编号必须在0-20之间，但第${i+1}个值为${xList[i]}`);
                        return false;
                    }
                }
                
                // 获取右侧奖励区容器
                const bonusGrid = document.getElementById('right-bonus-grid');
                if (!bonusGrid) {
                    console.error('找不到右侧奖励区容器');
                    return false;
                }
                
                // 清空现有内容
                bonusGrid.innerHTML = '';
                
                // 创建新的奖励单元格
                xList.forEach((x, index) => {
                    const cell = document.createElement('div');
                    cell.className = 'bonus-cell';
                    cell.setAttribute('data-index', index);
                    cell.setAttribute('data-x', x);

                    // 创建标签
                    const label = document.createElement('span');
                    label.className = 'bonus-label';
                    label.textContent = `回合助推板 ${x}`;

                    const img = document.createElement('img');
                    img.src = `images/bonus/${x}.png`;
                    img.alt = `助推板块 ${x}`;
                    
                    
                    cell.appendChild(img);
                    cell.appendChild(label);
                    bonusGrid.appendChild(cell);
                });
                
                console.log(`设置右侧助推板块: ${xList.length}个图片`);
                return true;
            }
            
            // 修改初始化函数
            function initializeRoundInfo() {
                // 初始化回合状态
                initializeRoundStates();
                
                // 设置默认计分图片
                for (let round = 1; round <= 6; round++) {
                    setRoundScoring(round, -1); // 默认使用-1.png
                }
                
                // 设置默认助推板块
                setBonusColumns([0, 0, 0, 0, 0, 0]);

                // 清除所有强调效果
                clearAllEmphasis();
                
                console.log('计分卡片初始化完成');
            }

            // 页面加载完成后初始化地图
            document.addEventListener('DOMContentLoaded', function() {
                generateHexMap();
                
                // 初始化地形（使用您提供的地形数据）
                const initialTerrain = [
                    [4,0,3,2,1,6,5,0,3,2,1,7,0],
                    [5,0,0,4,3,4,7,0,4,5,3,0,2],
                    [6,3,2,0,5,1,2,0,0,6,0,0,6],
                    [7,5,6,0,7,6,0,2,0,0,1,5,4],
                    [1,4,1,7,0,0,0,4,5,3,6,7,1],
                    [2,0,0,0,3,5,0,7,1,0,2,3,6],
                    [3,0,1,2,0,4,1,0,0,0,0,0,0],
                    [0,7,3,0,6,2,7,6,2,3,4,2,0],
                    [4,5,6,0,7,5,1,3,4,5,6,7,1]
                ];
                
                // 应用初始地形
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 13; col++) {
                        setHexTerrain(row, col, initialTerrain[row][col]);
                    }
                }
                // 初始化回合信息
                initializeRoundInfo();

            });
        </script>
    </body>
    </html>